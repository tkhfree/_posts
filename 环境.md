---
title: 搭建openstack问题
date: 2020-05-18 00:21:52
tags: 
	- OpenStack
comments: true
toc: true
mathjax: true
urlname:
categories:
thumbnail:
---

# 环境

ubuntu16.4 + devstack（pike）

controller：192.168.130.211

# 安装准备：

1. apt更改国内源并更新
2. 安装pip并升级
3. 更改pip源地址为国内
4. 安装git工具
5. 安装Open vSwitch

# 下载源包

```shell
git clone https://github.com/openstack-dev/devstack.git
```

目前Devstack脚本已经不支持直接使用root身份运行，你需要创建stack用户运行

```
cd /home/devstack/tools/
./create-stack-user.sh
```

修改devstack目录权限,让stack用户可以运行

```
chown -R stack:stack /home/devstack
```

切换的stack用户下

```
su stack
cd /home/devstack
```

进入devstack目录下，创建local.conf 文件

```shell
# Misc
DATABASE_PASSWORD=123456
ADMIN_PASSWORD=123456
SERVICE_PASSWORD=123456
SERVICE_TOKEN=123456
RABBIT_PASSWORD=123456
 
# Reclone each time
RECLONE=true
  
# Python enviroments
#OFFLINE=true
  
## For Keystone
KEYSTONE_TOKEN_FORMAT=PKI
  
## For Swift
#SWIFT_REPLICAS=1
#SWIFT_HASH=011688b44136573e209e
  
# Enable Logging
DEST=/home/stack
LOGFILE=$DEST/logs/stack.sh.log
VERBOSE=True
LOG_COLOR=True
SCREEN_LOGDIR=$DEST/logs
  
# Pre-requisite
ENABLED_SERVICES=rabbit,mysql,key
  
## If you want ZeroMQ instead of RabbitMQ (don't forget to un-declare 'rabbit' from the pre-requesite)
#ENABLED_SERVICES+=,-rabbit,-qpid,zeromq
  
## If you want Qpid instead of RabbitMQ (don't forget to un-declare 'rabbit' from the pre-requesite)
#ENABLED_SERVICES+=,-rabbit,-zeromq,qpid
  
# Horizon (Dashboard UI) - (always use the trunk)
ENABLED_SERVICES+=,horizon
#HORIZON_REPO=https://github.com/openstack/horizon
#HORIZON_BRANCH=master
  
# Nova - Compute Service
ENABLED_SERVICES+=,n-api,n-crt,n-obj,n-cpu,n-cond,n-sch,n-novnc,n-cauth
IMAGE_URLS+=",https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img"
  
## Nova Cells
ENABLED_SERVICES+=,n-cell
  
# Glance - Image Service
ENABLED_SERVICES+=,g-api,g-reg
  
# Swift - Object Storage
#ENABLED_SERVICES+=,s-proxy,s-object,s-container,s-account
  
# Neutron - Networking Service
# If Neutron is not declared the old good nova-network will be used
ENABLED_SERVICES+=,q-svc,q-agt,q-dhcp,q-l3,q-meta,neutron
  
## Neutron - Load Balancing
ENABLED_SERVICES+=,q-lbaas
  
## Neutron - VPN as a Service
ENABLED_SERVICES+=,q-vpn
  
## Neutron - Firewall as a Service
ENABLED_SERVICES+=,q-fwaas
  
# VLAN configuration - LinuxBridge + VLAN模式
Q_PLUGIN=linuxbridge
ENABLE_TENANT_VLANS=True
TENANT_VLAN_RANGE=1920:1930
PHYSICAL_NETWORK=default
LB_PHYSICAL_INTERFACE=eth0
  # VLAN configuration - Open VSwitch + VLAN模式  
  #ENABLE_TENANT_VLANS=True
  #TENANT_VLAN_RANGE=1920:1930
  #PHYSICAL_NETWORK=default
  #OVS_PHYSICAL_INTERFACE=eth0

# GRE tunnel configuration
#Q_PLUGIN=ml2
#ENABLE_TENANT_TUNNELS=True
  
# VXLAN tunnel configuration
#Q_PLUGIN=ml2
#Q_ML2_TENANT_NETWORK_TYPE=vxlan
  
# Cinder - Block Device Service
ENABLED_SERVICES+=,cinder,c-api,c-vol,c-sch
  
# Heat - Orchestration Service
ENABLED_SERVICES+=,heat,h-api,h-api-cfn,h-api-cw,h-eng
#IMAGE_URLS+=",http://fedorapeople.org/groups/heat/prebuilt-jeos-images/F17-x86_64-cfntools.qcow2"
  
# Ceilometer - Metering Service (metering + alarming)
CEILOMETER_BACKEND=mysql
ENABLED_SERVICES+=,ceilometer-acompute,ceilometer-acentral,ceilometer-collector,ceilometer-api
ENABLED_SERVICES+=,ceilometer-alarm-notify,ceilometer-alarm-eval
  
# Apache fronted for WSGI
APACHE_ENABLED_SERVICES+=keystone,swift
```

# 预防问题

1. 手动下载各个组件的的包，解压至/opt/stack下并使用git工具初始化各个组件的仓库

2. 手动下载requirement包，并手动安装依赖包

   ```shell
   pip install -r upper-requirement.txt
   ```

3. 一定要升级pip工具，如果遇到setuptools、get-pip.py之类的报错，基本就是pip安装与easy_install安装这两种python包管理工具的冲突，使用pip升级setuptool、disturb
4. 安装过程中比较难下的还有etcd-v3.1.7，stestr等，都可以提前下好
5. 如果报缺少openstack_auth，重写安装dajago_openstack_auth
6. 缺少model_query，全局搜索_model_query，复制到/usr/local/bin
7. 要安装p4插件，提前下好heat、heat-dashboard、networking-sfc、networking-p4
8. p4的底层驱动behavioral-model里有一个bvm2.py的脚本，脚本里有一个在临时文件夹下下载thrift的命令，可以手动下载，同时脚本的thrift0.7.0版本貌似不兼容，下载thrift0.10.0可以运行
9. 如果keystone日志报uwsgi没有启动，删除/etc/keystone/***.ini脚本里plugins=python