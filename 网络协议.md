---
title: 网络协议
toc: true
thumbnail: 'https://pic.downk.cc/item/5eda03efc2a9a83be5241038.jpg'
comments: true
tags:
  - Network
date: 2020-09-09 16:53:07
urlname:
categories:
---

### 概述

#### 分层

网络有上层必有上层，比如TCP的三次握手，每次握手必有ip头和mac头部；**可以有下层没上层，不能有上层没下层。**网络上跑的包，有的包可以只有mac头，但是不能只有ip头没有mac头。

MTU是二层的概念，也就是MAC头和正文不允许超过1500字节，如果放不下就需要分片处理。

##### 为什么不通过MAC地址直接定位机器？

因为ip有定位功能，mac就像身份证号，ip就像门牌号，通过身份证号询问找人难度很大。

##### 主机通讯

主机会先判断通讯的是否是同网段的，如果是同网段，发送arp请求，获得目的主机的mac地址，将本机mac地址和目的主机的mac地址填入MAC头，进行发送。

如果不是同网段，主机会将包发送到网关，将目的MAC地址填入网关的MAC地址。

#### DHCP

新加入的主机只知道自己的MAC地址，发送DHCP Discover，相当于吼一句我是新来的，MAC地址是xxxxxxxx，没有ip。

DHCP Discover：使用IP为0.0.0.0的地址发送一个广播，目的ip255.255.255.255，广播包封装UDP，UDP封装BOOTP。

DHCP Discover：

|              mac头              |                  ip头                  |           UDP头            |   BOOTP头    |            正文             |
| :-----------------------------: | :------------------------------------: | :------------------------: | :----------: | :-------------------------: |
| src本机mac<br />dst广播FFFFFFFF | src0.0.0.0<br />dst广播255.255.255.255 | srcport:68<br />dstport:67 | boot request | 本机mac是这个，还没有ip地址 |

DHCP Offer：

|                 mac头                 |                    ip头                     |           UDP头            |  BOOTP头   |          正文           |
| :-----------------------------------: | :-----------------------------------------: | :------------------------: | :--------: | :---------------------: |
| srcDHCP服务器mac<br />dst广播FFFFFFFF | srcDHCP服务器IP<br />dst广播255.255.255.255 | srcport:67<br />dstport:68 | boot reply | 你mac是这个，分配ip给你 |

DHCP request：

|              mac头              |                  ip头                  |           UDP头            |   BOOTP头    |                 正文                  |
| :-----------------------------: | :------------------------------------: | :------------------------: | :----------: | :-----------------------------------: |
| src本机mac<br />dst广播FFFFFFFF | src0.0.0.0<br />dst广播255.255.255.255 | srcport:68<br />dstport:67 | boot request | 本机mac是这个，准备租用这个DHCP分配ip |

DHCP ACK：

|                 mac头                 |                    ip头                     |           UDP头            |  BOOTP头   |               正文               |
| :-----------------------------------: | :-----------------------------------------: | :------------------------: | :--------: | :------------------------------: |
| srcDHCP服务器mac<br />dst广播FFFFFFFF | srcDHCP服务器IP<br />dst广播255.255.255.255 | srcport:67<br />dstport:68 | boot reply | DHCP ACK这个新人ip是在我这租用的 |